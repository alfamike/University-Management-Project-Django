{% extends 'base.html' %}

{% block title %}Student Detail{% endblock %}

{% block content %}
<div class="student-detail-container">
    <!-- Header Section -->
    <div class="student-header">
        <h1 class="page-title">{{ student.first_name }} {{ student.last_name }}</h1>
        <p class="student-email">{{ student.email }}</p>
    </div>

    <!-- Details Section -->
    <div class="student-details">
        <div class="details-card">
            <h2 class="details-title">Student Information
                <button id="edit-student-btn" class="btn">Edit</button>
            </h2>
            <div class="details-content">
                <div class="detail-item">
                    <span class="detail-label">First Name:</span>
                    <span class="detail-value">{{ student.first_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Name:</span>
                    <span class="detail-value">{{ student.last_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ student.email }}</span>
                </div>
<!--                <div class="detail-item">-->
<!--                    <span class="detail-label">Enrollment Date:</span>-->
<!--                    <span class="detail-value">{{ student.enrollment_date }}</span>-->
<!--                </div>-->
            </div>
        </div>
    </div>

    <!-- Related Courses Section -->
    <div class="related-courses">
        <h2 class="details-title">Enrolled Courses
            <button id="add-course-btn" class="btn">Add Course</button>
            <button id="delete-course-btn" class="btn">Remove Course</button>
            <button id="show-activities-course-btn" class="btn">Show Activities</button>
            <button id="manage-grade-btn" class="btn">Manage Grade</button>
        </h2>
        {% if student.courses %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Course Name</th>
                        <th>Description</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Grade</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in student.courses %}
                        <tr>
                            <td><input type="checkbox" class="course-checkbox" value="{{ course.id }}"></td>
                            <td>{{ course.name }}</td>
                            <td>{{ course.description }}</td>
                            <td>{{ course.start_date }}</td>
                            <td>{{ course.end_date }}</td>
                            <td>
                                {% for grade in course_grades %}
                                    {% if grade.course_id == course.id %}
                                        {{ grade.grade }}
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="cards">
                {% for course in student.courses %}
                    <div class="card">
                        <h3>{{ course.name }}</h3>
                        <p>{{ course.description }}</p>
                        <p><strong>Start Date:</strong> {{ course.start_date }}</p>
                        <p><strong>End Date:</strong> {{ course.end_date }}</p>
                        <p><strong>Grade:</strong>
                            {% for grade in course_grades %}
                                {% if grade.course_id == course.id %}
                                    {{ grade.grade }}
                                {% endif %}
                            {% endfor %}
                        </p>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-courses">This student is not enrolled in any courses.</p>
        {% endif %}
    </div>

    <!-- Student's Activities Section -->
    <div id="activities-section" style="display: none;">
        <h2 class="details-title">Activities
            <button id="manage-activity-btn" class="btn">Manage Grade</button>
        </h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Activity Name</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="activities-table-body">
                <!-- Activities will be populated here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Pop-up for adding a course -->
<div id="add-course-popup" class="popup">
    <div class="popup-content">
        <span class="close-btn">&times;</span>
        <h3>Add Course to student</h3>
        <form id="add-course-form">
            <label for="course-title">Title:</label>
            <select id="course-title" name="course-title" class="filter-dropdown">
                <!-- Options for titles -->
            </select>
            <label for="course-name">Course:</label>
            <select id="course-name" name="course-name" class="filter-dropdown">
                <!-- Options for courses related to the selected title -->
            </select>
            <button type="submit" class="btn">Add</button>
        </form>
    </div>
</div>

<!-- Pop-up for managing a grade of a course -->
<div id="manage-grade-popup" class="popup">
    <div class="popup-content">
        <span class="close-btn">&times;</span>
        <h3>Add Grade to Course</h3>
        <form id="manage-grade-form">
            <label for="course-grade-select">Course:</label>
            <select id="course-grade-select" name="course-select" class="filter-dropdown">
                <!-- Options for courses -->
            </select>
            <label for="grade-input">Grade:</label>
            <input type="number" id="grade-input" name="grade-input" min="0" max="100" required>
            <button type="submit" class="btn">Apply</button>
        </form>
    </div>
</div>

<!-- Pop-up for managing a grade of an activity -->
<div id="manage-grade-activity-popup" class="popup">
    <div class="popup-content">
        <span class="close-btn">&times;</span>
        <h3>Add Grade to Activity</h3>
        <form id="manage-grade-activity-form">
            <label for="activity-grade-select">Activity:</label>
            <select id="activity-grade-select" name="activity-select" class="filter-dropdown">
                <!-- Options for activities -->
            </select>
            <label for="activity-grade-input">Grade:</label>
            <input type="number" id="activity-grade-input" name="grade-input" min="0" max="100" required>
            <button type="submit" class="btn">Apply</button>
        </form>
    </div>
</div>

<!-- Pop-up for editing student information -->
<div id="edit-student-popup" class="popup">
    <div class="popup-content">
        <span class="close-btn">&times;</span>
        <h3>Edit Student Information</h3>
        <form id="edit-student-form">
            <label for="edit-first-name">First Name:</label>
            <input type="text" id="edit-first-name" name="first-name" value="{{ student.first_name }}">
            <label for="edit-last-name">Last Name:</label>
            <input type="text" id="edit-last-name" name="last-name" value="{{ student.last_name }}">
            <label for="edit-email">Email:</label>
            <input type="email" id="edit-email" name="email" value="{{ student.email }}">
            <button type="submit" class="btn">Save</button>
        </form>
    </div>
</div>
<style>
    .student-detail-container {
        padding: 2rem;
    }

    .student-header {
        background-color: #3B5998;
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        text-align: center;
    }

    .student-header .page-title {
        font-size: 2.5rem;
        margin: 0;
    }

    .student-header .student-email {
        font-size: 1.2rem;
        margin-top: 0.5rem;
    }

    .student-details {
        margin-bottom: 2rem;
    }

    .details-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .details-title {
        font-size: 1.8rem;
        margin-bottom: 1rem;
        color: #3B5998;
        text-align: left;
    }

    .details-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: bold;
        color: #555;
    }

    .detail-value {
        color: #333;
    }

    .related-courses {
        margin-top: 2rem;
    }

    .related-courses .table {
        width: 100%;
        border-collapse: collapse;
    }

    .related-courses .table th,
    .related-courses .table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }

    .related-courses .table th {
        background-color: #f4f4f4;
    }

    .related-courses .table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .related-courses .no-courses {
        font-size: 1.2rem;
        color: #888;
        text-align: center;
        margin-top: 1rem;
    }

    .related-courses .table {
        display: table;
    }
    .related-courses .cards {
        display: none;
    }

    @media (max-width: 768px) {
        .related-courses .table {
            display: none;
        }

        .related-courses .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .related-courses .card {
            border: 1px solid #ccc;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            max-width: 100%;
        }

        #delete-course-btn {
            display: none;
        }

        #show-activities-course-btn {
            display: none;
        }

        #activities-section {
            display: none;
        }

    }

    .popup {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .popup-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        border-radius: 8px;
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    #activities-section {
        display: none;
    }
</style>

<script>
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Get student ID
    const student = {{ student.id }};

    document.addEventListener('DOMContentLoaded', function() {
        const titles = {{ titles|safe }};
        const courses = {{ courses|safe }};
        const student_courses = {{ student.courses|safe }};
        const titleSelect = document.getElementById('course-title');
        const courseSelect = document.getElementById('course-name');
        const courseSelect2 = document.getElementById('course-grade-select');

        // Populate titles dropdown
        titles.forEach(title => {
            const option = document.createElement('option');
            option.value = title.id;
            option.textContent = title.name;
            titleSelect.appendChild(option);
        });

        // Event listener for title selection change
        titleSelect.addEventListener('change', function() {
            const titleId = parseInt(this.value);
            courseSelect.innerHTML = ''; // Clear previous options

            // Filter and populate courses based on selected title
            courses.filter(course => course.title === titleId).forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelect.appendChild(option);
            });
        });

        // Populate course dropdown for managing grades
        student_courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.name;
            courseSelect2.appendChild(option);
        });

        // Event listener for "Show Activities" button
        document.getElementById('show-activities-course-btn').addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.course-checkbox:checked');
            const activitiesTableBody = document.getElementById('activities-table-body');
            const activitiesSection = document.getElementById('activities-section');

            if (selectedCheckboxes.length === 1) {
                const selectedCourseId = selectedCheckboxes[0].value;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch('/get_activities_by_course_of_activity_grades/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        course_id: selectedCourseId,
                        activities_grades: {{ activity_grades|safe }}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    activitiesTableBody.innerHTML = ''; // Clear previous activities
                    const activityGradeSelect = document.getElementById('activity-grade-select');
                    activityGradeSelect.innerHTML = ''; // Clear previous options

                    data.activities.forEach(activity => {
                        const row = `
                            <tr>
                                <td>${activity.name}</td>
                                <td>${activity.description}</td>
                                <td>${activity.due_date}</td>
                                <td>${activity.grade}</td>
                            </tr>
                        `;
                        activitiesTableBody.insertAdjacentHTML('beforeend', row);

                        // Populate activities dropdown for managing grades

                        const option = document.createElement('option');
                        option.value = activity.id;
                        option.textContent = activity.name;
                        activityGradeSelect.appendChild(option);

                    });

                    activitiesSection.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
            } else {
                activitiesSection.style.display = 'none';
                alert('Please select exactly one course to view activities.');
                return;
            }
        });
    });

    document.getElementById('add-course-btn').addEventListener('click', function() {
        document.getElementById('add-course-popup').style.display = 'block';
    });

    document.getElementById('manage-grade-btn').addEventListener('click', function() {
        document.getElementById('manage-grade-popup').style.display = 'block';
    });

    document.getElementById('manage-activity-btn').addEventListener('click', function() {
        document.getElementById('manage-grade-activity-popup').style.display = 'block';
    });

    document.getElementById('add-course-popup').querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('add-course-popup').style.display = 'none';
    });

    document.getElementById('manage-grade-popup').querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('manage-grade-popup').style.display = 'none';
    });

    document.getElementById('manage-grade-activity-popup').querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('manage-grade-activity-popup').style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target == document.getElementById('add-course-popup')) {
            document.getElementById('add-course-popup').style.display = 'none';
        }

        if (event.target == document.getElementById('manage-grade-popup')) {
            document.getElementById('manage-grade-popup').style.display = 'none';
        }

        if (event.target == document.getElementById('manage-grade-activity-popup')) {
            document.getElementById('manage-grade-activity-popup').style.display = 'none';
        }
    });

    document.getElementById('delete-course-btn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.course-checkbox:checked');
        const selectedCourses = Array.from(checkboxes).map(checkbox => checkbox.value);

        if (selectedCourses.length > 0) {
            fetch(`/deEnrollCourses/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({ course_ids: selectedCourses, pk: student })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the selected courses from the table
                    selectedCourses.forEach(courseId => {
                        document.querySelector(`.course-checkbox[value="${courseId}"]`).closest('tr').remove();
                    });
                    location.reload();
                } else {
                    alert('Failed to de-enroll courses.');
                }
            })
            .catch(error => console.error('Error:', error));
        } else {
            alert('No courses selected.');
        }

    });


    document.getElementById('add-course-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const course = document.getElementById('course-name').value;

        fetch(`/enrollCourses/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ course_id: course , pk: student })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Failed to enroll in course.');
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('manage-grade-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const courseId = document.getElementById('course-grade-select').value;
        const grade = document.getElementById('grade-input').value;

        fetch(`/manageGradeToCourse/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                student_id: student,
                course_id: courseId,
                grade: grade
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Failed to manage grade.');
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('manage-grade-activity-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const activityId = document.getElementById('activity-grade-select').value;
        const grade = document.getElementById('activity-grade-input').value;

        fetch(`/manageGradeToActivity/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                student_id: student,
                activity_id: activityId,
                grade: grade
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Failed to manage grade.');
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('edit-student-btn').addEventListener('click', function() {
        document.getElementById('edit-student-popup').style.display = 'block';
    });

    document.getElementById('edit-student-popup').querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('edit-student-popup').style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target == document.getElementById('edit-student-popup')) {
            document.getElementById('edit-st-student-popup').style.display = 'none';
        }
    });

    document.getElementById('edit-student-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const firstName = document.getElementById('edit-first-name').value;
        const lastName = document.getElementById('edit-last-name').value;
        const email = document.getElementById('edit-email').value;

        fetch(`/modifyStudent/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                id: {{ student.id }},
                first_name: firstName,
                last_name: lastName,
                email: email
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Failed to edit student information.');
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>

{% endblock %}
