<!-- home.html -->
{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h1>Welcome to the University Management System</h1>
<p>This is the dashboard where you can manage university data.</p>

<!-- Chatbot UI -->
<div class="chatbox">
    <div aria-live="polite" class="chat-container" id="chat-container">
        <!-- Chat messages will appear here -->
    </div>
    <div class="chat-input-container">
        <textarea id="user-input" onkeypress="handleKeyPress(event)" placeholder="Type a message..." ></textarea>
        <span class="send-icon" onclick="sendMessage()">&#x27A4;</span>
    </div>
</div>

<script>
    // Get DOM elements
    const userInput = document.getElementById('user-input');
    const chatContainer = document.getElementById('chat-container');

    // Function to send the user message to the server
    function sendMessage() {
        const message = userInput.value;
        if (!message) return; // Don't send empty messages

        // Append user message to chat container
        chatContainer.innerHTML += `<div class="user-message">${message}</div>`;
        scrollToBottom();

        userInput.value = ''; // Clear input box

        // Get CSRF token from the document
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Send message to the Django server using AJAX (fetch API)
        fetch('/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ message: message }),
        })
        .then(response => response.json())
        .then(data => {
            // Append server response to chat container
            chatContainer.innerHTML += `<div class="bot-message">${data.response}</div>`;
            scrollToBottom();
        })
        .catch(error => {
            console.error('Error:', error);
            chatContainer.innerHTML += `<div class="bot-message">Sorry, there was an issue processing your message. Please try again later.</div>`;
            scrollToBottom();
        });
    }

    // Handle Enter key press to send message
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // Scroll to the bottom of the chat container
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>

<style>
    /* Chatbot styles */
    .chatbox {
        position: fixed;
        bottom: 20px;
        left: 250px;
        width: calc(80% - 250px);
        max-width: calc(100% - 250px);
        padding: 20px;
        border-radius: 8px;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }

    .chat-container {
        max-height: 600px;
        overflow-y: auto;
        margin-bottom: 10px;
        flex-grow: 1;
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .user-message, .bot-message {
        margin: 10px;
        padding: 10px;
        border-radius: 5px;
        max-width: 80%;
        animation: fadeIn 0.3s ease-out;
    }

    .user-message {
        background-color: #d1e7ff;
        align-self: flex-start;
        word-wrap: break-word;
        word-break: break-word;
    }

    .bot-message {
        background-color: #e1f7d5;
        align-self: flex-end;
        word-wrap: break-word;
        word-break: break-word;
    }

    .chat-input-container {
        display: flex;
        align-items: center;
        width: 100%;
        position: relative;
    }

    #user-input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .send-icon {
        position: absolute;
        right: 10px;
        cursor: pointer;
        font-size: 1.2rem;
        color: #337ab7;
        background: none;
        border: none;
    }

    .send-icon:hover {
        color: #0056b3;
    }

    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }

    /* Mobile view adjustments */
    @media (max-width: 768px) {
        .chatbox {
            left: 0;
            width: 100%;
            max-width: 100%;
            padding: 10px;
        }

        #user-input {
            width: calc(100% - 40px);
        }
    }
</style>

{% endblock %}
